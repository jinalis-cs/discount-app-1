<div class="discount-block" data-product-id="{{ product.id }}" {{ block.shopify_attributes }}>
  <div class="discount-loading">Loading discounts...</div>
  <div class="discount-container" style="display: none;">
    <h3 class="discount-title">{{ block.settings.heading }}</h3>
    <div class="discount-list"></div>
  </div>
</div>

<script>
  (function () {
    const block = document.currentScript.previousElementSibling;
    const productId = block.getAttribute('data-product-id');
    const productGid = `gid://shopify/Product/${productId}`;
    const loadingDiv = block.querySelector('.discount-loading');
    const containerDiv = block.querySelector('.discount-container');
    const discountList = block.querySelector('.discount-list');

    // Fetch discounts via AJAX
    async function fetchDiscounts() {
      try {
        const response = await fetch(`/apps/discount?shop=${Shopify.shop}&product_id=${productId}`);
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        console.log('Fetched discount data:', data.discountJSON);
        displayDiscounts(data.discountJSON || []);
      } catch (error) {
        loadingDiv.textContent = 'Error fetching discounts.';
      }
    }

    function displayDiscounts(discounts) {
      loadingDiv.style.display = 'none';
      containerDiv.style.display = 'block';

      if (discounts.length == 0) {
        loadingDiv.innerHTML = '<p class="no-discounts">No active discounts available for this product</p>';
        return;
      }

      discounts.forEach(discount => {
        const title = discount.discountTitle;
        const code = discount.discountCodes;
        let showDiscount = false;

        // Case 1: Product-specific discount
        if (discount.products && discount.products.id === productGid) {
          showDiscount = true;
        }

        // Case 2: Free shipping discount
        if (discount.discountType === 'DiscountCodeFreeShipping') {
          showDiscount = true;
        }

        // Case 3: Collection-specific discount
        if (discount.collections && productCollections.length) {
          const discountCollectionHandle = discount.collections.handle;
          const productInCollection = productCollections.some((col) => col.handle === discountCollectionHandle);
          if (productInCollection) {
            showDiscount = true;
          }
        }

        if (!showDiscount) return;
        const discountItem = document.createElement('div');
        discountItem.className = 'discount-item';
        discountItem.innerHTML = `
            <div style="padding:10px;border:1px dashed #ccc;margin:10px 0;border-radius:5px;">
                <strong>${title}</strong><br>
                <code style="background:#f0f0f0;padding:5px 10px;border-radius:3px;">
                    ${code}
                </code>
                <button onclick="copyCode('${code}')" style="margin-left:10px;padding:5px 10px;">
                    Copy
                </button>
            </div>
        `;
        console.log(discountItem)
        discountList.appendChild(discountItem);
      });
    }

    if (productId) {
      fetchDiscounts();
    }
  })();
</script>

{% schema %}
{
  "name": "Product Discounts",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Available Discounts"
    },
    {
      "type": "range",
      "id": "heading_size",
      "min": 14,
      "max": 32,
      "step": 1,
      "unit": "px",
      "label": "Heading Size",
      "default": 20
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#f9fafb"
    },
    {
      "type": "color",
      "id": "code_color",
      "label": "Code Color",
      "default": "#dc2626"
    },
    {
      "type": "color",
      "id": "value_color",
      "label": "Value Color",
      "default": "#059669"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Color",
      "default": "#2563eb"
    },
    {
      "type": "range",
      "id": "margin_top",
      "min": 0,
      "max": 50,
      "step": 5,
      "unit": "px",
      "label": "Margin Top",
      "default": 20
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "min": 0,
      "max": 50,
      "step": 5,
      "unit": "px",
      "label": "Margin Bottom",
      "default": 20
    }
  ]
}
{% endschema %}
